 {% extends 'base.html' %} {% block content %}
    
<!--from: http://flask.pocoo.org/docs/1.0/patterns/flashing/-->
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul class=flashes>
    {% for message in messages %}
      <li>{{ message }}</li>
    {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

    <div id="barChart"></div>
    <div id="difficultyChart"></div>
    <div id="ratingsChart"></div>

    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>-->
    <!--<script type="text/javascript" src="static/js/graph.js"></script>-->

<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/dc/1.6.0/dc.css"></script>-->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>-->

<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.2.0/dc.min.js"></script>-->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.2.0/dc.min.js.map"></script>-->

    <script type="text/javascript" src="static/js/d3.min.js"></script>
    <script type="text/javascript" src="static/js/crossfilter.min.js"></script>
    <script type="text/javascript" src="static/js/dc.min.js"></script>
    <script type="text/javascript" src="static/js/queue.min.js"></script>
    <script>


function getParsedData(){
 let stringData = "{{ imported_data|safe }}";
// below line of code from: https://stackoverflow.com/questions/16450250/javascript-replace-single-quote-with-double-quote
// changes singe quotes to double quotes
//required to parse data
let stringDataWithDoubleQuotes = stringData.replace(/'/g, '"');
let data = JSON.parse(stringDataWithDoubleQuotes);
var ndx = crossfilter(data); 
return ndx;
}

ndx = getParsedData()

function showCategoriesChart(ndx){

let  chart= dc.rowChart("#barChart")
let dim = ndx.dimension(dc.pluck("Categories"));

// https://stackoverflow.com/questions/17524627/is-there-a-way-to-tell-crossfilter-to-treat-elements-of-array-as-separate-record?noredirect=1&lq=1
function reduceAdd(p, v) {
  v.Categories.forEach (function(val, idx) {
     p[val] = (p[val] || 0) + 1; //increment counts
  });
  return p;
}

function reduceRemove(p, v) {
  v.Categories.forEach (function(val, idx) {
     p[val] = (p[val] || 0) - 1; //decrement counts
  });
  return p;
   
}

function reduceInitial() {
  return {};  
}



let group = dim.groupAll().reduce(reduceAdd, reduceRemove, reduceInitial).value();;

// hack to make dc.js charts work
group.all = function() {
  var newObject = [];
  for (var key in this) {
    if (this.hasOwnProperty(key) && key != "all") {
      newObject.push({
        key: key,
        value: this[key]
      });
    }
  }
  return newObject;
};




// //https://stackoverflow.com/questions/29916853/how-to-display-a-graph-of-top-n-items
// let topTenCategories = (function (group) {return {
//   all:function () {
//     return group.top(10).filter(function(d) {
//       return d.key != "Not mentioned";
//      });
//   }
// };})(group);



//https://github.com/dc-js/dc.js/blob/master/web/examples/row.html
chart
    .width(768)
    .height(480)
    .filter(function(d){
        if(d != ""){
            return d
        }
    })
    .x(d3.scale.ordinal())
    // .xUnits(dc.units.ordinal)
    .elasticX(true)
    .dimension(dim)
    .group(group)
    // .xAxisLabel("Count")
    // .yAxisLabel("Recipe")
    .render();

chart.ordering(function(d) { return -d.value; });

}

showCategoriesChart(ndx)

function showDifficultyChart(ndx){
    
    let chart = dc.pieChart("#difficultyChart")
let dim = ndx.dimension(dc.pluck("Difficulty"));

let group = dim.group();

//https://github.com/dc-js/dc.js/blob/master/web/examples/pie.html
 chart
    .width(768)
    .height(480)
    .slicesCap(4)
    .innerRadius(100)
    .dimension(dim)
    .group(group)
    .legend(dc.legend())
  chart.render();

};

showDifficultyChart(ndx)


function showRatingsChart(ndx){
    let chart= dc.barChart("#ratingsChart");
let dim = ndx.dimension(dc.pluck("Rating"));

let group = dim.group();
//from D3 Daskboard Lesson
chart
        .width(400) //width of whole chart
        .height(300)
        .margins({ top: 10, right: 50, bottom: 30, left: 50 }) //spacing whole chart
        .dimension(dim) //the dim and group we selected earlier
        .group(group)
        .transitionDuration(500)
        .x(d3.scale.ordinal()) //Scales ordinaliy?
        .xUnits(dc.units.ordinal) // Tell Dc.js that we're using an ordinal x axis
        .xAxisLabel("Average Rating")
        .yAxis().ticks(20); //the number of ticks
        
    chart.render();
}



showRatingsChart(ndx);

    </script>
    

{% endblock %}Chart